# 功能说明 - 自动切换学习类型（必修/选修）

## 📋 功能概述

插件现在可以**智能识别学习进度**，当**必修课程学满**后，自动切换到**选修课程**继续学习。

### 学习进度示例

**必修学习进度：**
```
20.00学时 / 20学时 (100%) ✅ 已完成
```

**选修学习进度：**
```
4.26学时 / 30学时 (14.2%) ⚠️ 未完成
```

**插件行为：**
- ✅ 检测到必修已完成 → 自动点击"选修"标签
- ✅ 切换到选修课程列表
- ✅ 继续自动学习选修课程

---

## 🔄 工作流程

### 完整的自动化学习流程

```
启动插件
  ↓
检测课程列表页面
  ↓
📊 读取学习进度
  ├─ 必修: 20/20学时 (100%)
  └─ 选修: 4.26/30学时 (14.2%)
  ↓
判断：必修完成 且 选修未完成 ✅
  ↓
🔘 查找"选修"标签
  ↓
✅ 点击"选修"标签
  ↓
等待1秒（页面切换）
  ↓
检测选修课程列表
  ↓
🎯 找到未完成的选修课程
  ↓
自动点击并学习
  ↓
继续自动化学习流程...
```

---

## 💡 智能判断逻辑

### 判断条件

```javascript
if (必修进度 >= 100% && 选修进度 < 100%) {
  // 切换到选修
  点击"选修"标签;
} else if (必修进度 < 100%) {
  // 继续学习必修
  console.log('继续学习必修课程');
} else {
  // 都完成了
  console.log('必修和选修都已完成！');
}
```

### 三种场景

| 场景 | 必修进度 | 选修进度 | 插件行为 |
|------|---------|---------|---------|
| **场景1** | 80% | 10% | ✅ 继续学习必修课程 |
| **场景2** | 100% | 14.2% | ✅ 自动切换到选修，学习选修课程 |
| **场景3** | 100% | 100% | 🎉 显示"都已完成" |

---

## 🔍 实现细节

### 1. 学习进度识别

**HTML结构：**
```html
<!-- 必修学习进度 -->
<div data-v-a2a750ea>
  <div class="fs_16">必修学习进度</div>
  <span class="c_red">20.00学时</span> /20学时
</div>

<!-- 选修学习进度 -->
<div data-v-a2a750ea>
  <div class="fs_16">选修学习进度</div>
  <span class="c_red">4.26学时</span> /30学时
</div>
```

**提取逻辑：**
```javascript
// 查找包含学习进度的元素
const progressElements = document.querySelectorAll('[data-v-a2a750ea]');

for (const elem of progressElements) {
  const text = elem.textContent;
  
  if (text.includes('必修学习进度')) {
    // 正则匹配：20.00学时 /20学时
    const match = text.match(/([\d.]+)学时\s*\/([\d.]+)学时/);
    if (match) {
      const completed = parseFloat(match[1]);  // 20.00
      const total = parseFloat(match[2]);      // 20
      const percentage = (completed / total) * 100;  // 100%
    }
  }
}
```

### 2. 选修标签识别与点击

**查找选修标签：**
```javascript
// 查找所有可能的标签元素
const tabs = document.querySelectorAll('.item, [class*="tab"]');

for (const tab of tabs) {
  const text = tab.textContent.trim();
  
  if (text === '选修' || text.includes('选修')) {
    // 找到选修标签
    console.log('找到选修标签，准备点击');
    
    setTimeout(() => {
      tab.click();  // ✅ 点击选修标签
      console.log('已点击选修标签');
    }, 1000);
    
    return true;  // 返回true表示正在切换
  }
}
```

**等待页面更新：**
- 点击后返回`true`
- `handleCourseListPage`函数返回，停止处理当前课程列表
- 3秒后检测循环再次运行
- 检测到新的选修课程列表
- 继续自动学习

### 3. 完整的检测函数

```javascript
function checkAndSwitchLearningType() {
  // 1. 检查是否在主页（myClass页面）
  if (!window.location.hash.includes('/myClass')) {
    return false;
  }
  
  // 2. 查找并解析学习进度
  const progressElements = document.querySelectorAll('[data-v-a2a750ea]');
  let requiredProgress = null;  // 必修进度
  let electiveProgress = null;  // 选修进度
  
  for (const elem of progressElements) {
    const text = elem.textContent;
    if (text.includes('必修学习进度')) {
      // 提取必修进度
      const match = text.match(/([\d.]+)学时\s*\/([\d.]+)学时/);
      if (match) {
        requiredProgress = {
          completed: parseFloat(match[1]),
          total: parseFloat(match[2]),
          percentage: (parseFloat(match[1]) / parseFloat(match[2])) * 100
        };
      }
    } else if (text.includes('选修学习进度')) {
      // 提取选修进度
      const match = text.match(/([\d.]+)学时\s*\/([\d.]+)学时/);
      if (match) {
        electiveProgress = {
          completed: parseFloat(match[1]),
          total: parseFloat(match[2]),
          percentage: (parseFloat(match[1]) / parseFloat(match[2])) * 100
        };
      }
    }
  }
  
  // 3. 输出学习进度
  console.log('📊 学习进度:');
  console.log(`  必修: ${requiredProgress.completed}/${requiredProgress.total}学时 (${requiredProgress.percentage.toFixed(1)}%)`);
  console.log(`  选修: ${electiveProgress.completed}/${electiveProgress.total}学时 (${electiveProgress.percentage.toFixed(1)}%)`);
  
  // 4. 判断是否需要切换到选修
  if (requiredProgress.percentage >= 100 && electiveProgress.percentage < 100) {
    console.log('✅ 必修已完成，需要切换到选修');
    
    // 5. 查找并点击"选修"标签
    const tabs = document.querySelectorAll('.item, [class*="tab"]');
    for (const tab of tabs) {
      const text = tab.textContent.trim();
      if (text === '选修' || text.includes('选修')) {
        console.log('🔘 找到选修标签，准备点击', tab);
        setTimeout(() => {
          tab.click();
          console.log('✅ 已点击选修标签');
        }, 1000);
        return true;  // 返回true，暂停课程列表处理
      }
    }
  }
  
  return false;
}
```

---

## 📊 Console输出示例

### 场景1：必修未完成

```
[自动学习助手] 📚 找到课程: 15个
[自动学习助手] 📊 学习进度:
  必修: 15.5/20学时 (77.5%)
  选修: 4.26/30学时 (14.2%)
[自动学习助手] 📚 必修未完成，继续学习必修课程
[自动学习助手] 🎯 准备学习: 课程标题
```

### 场景2：必修完成，切换到选修

```
[自动学习助手] 📚 找到课程: 20个
[自动学习助手] 📊 学习进度:
  必修: 20.00/20学时 (100.0%)
  选修: 4.26/30学时 (14.2%)
[自动学习助手] ✅ 必修已完成，需要切换到选修
[自动学习助手] 🔘 找到选修标签，准备点击 <div class="item">选修</div>
[自动学习助手] ✅ 已点击选修标签
[自动学习助手] ⏸️ 正在切换学习类型，等待页面更新

(3秒后，检测循环再次运行)

[自动学习助手] 📚 找到课程: 25个
[自动学习助手] 📊 学习进度:
  必修: 20.00/20学时 (100.0%)
  选修: 4.26/30学时 (14.2%)
[自动学习助手] 🎯 准备学习: 选修课程标题
```

### 场景3：都已完成

```
[自动学习助手] 📚 找到课程: 50个
[自动学习助手] 📊 学习进度:
  必修: 20.00/20学时 (100.0%)
  选修: 30.00/30学时 (100.0%)
[自动学习助手] 🎉 必修和选修都已完成！
[自动学习助手] ✅ 当前页所有课程已完成
```

---

## 🧪 测试方法

### 测试1：必修完成，自动切换到选修

**前提条件：**
- 必修进度：20/20学时（100%）
- 选修进度：< 30学时

**测试步骤：**
1. 打开课程列表页面（myClass页面）
2. 启动插件
3. 观察Console输出

**预期结果：**
```
[自动学习助手] 📊 学习进度:
  必修: 20.00/20学时 (100.0%)
  选修: 4.26/30学时 (14.2%)
[自动学习助手] ✅ 必修已完成，需要切换到选修
[自动学习助手] 🔘 找到选修标签，准备点击
[自动学习助手] ✅ 已点击选修标签
(页面切换到选修课程列表)
[自动学习助手] 🎯 准备学习: 选修课程标题
```

### 测试2：必修未完成，继续学习必修

**前提条件：**
- 必修进度：< 20学时

**预期结果：**
```
[自动学习助手] 📚 必修未完成，继续学习必修课程
[自动学习助手] 🎯 准备学习: 必修课程标题
```

### 测试3：验证学习进度识别

在课程列表页面，打开Console执行：

```javascript
// 手动测试学习进度识别
const progressElements = document.querySelectorAll('[data-v-a2a750ea]');
for (const elem of progressElements) {
  const text = elem.textContent;
  if (text.includes('学习进度')) {
    console.log('找到学习进度:', text);
    const match = text.match(/([\d.]+)学时\s*\/([\d.]+)学时/);
    if (match) {
      console.log(`  已完成: ${match[1]}学时`);
      console.log(`  总共: ${match[2]}学时`);
      console.log(`  完成度: ${((parseFloat(match[1]) / parseFloat(match[2])) * 100).toFixed(1)}%`);
    }
  }
}
```

---

## 💡 技术要点

### 1. 为什么在课程列表页面检测？

```javascript
// 在handleCourseListPage函数开头检测
async function handleCourseListPage(courseCards) {
  // 先检查是否需要切换学习类型
  if (checkAndSwitchLearningType()) {
    // 正在切换，暂停课程列表处理
    return;
  }
  
  // 继续处理课程列表
  // ...
}
```

**原因：**
- 课程列表页面（myClass）包含学习进度信息
- 在处理课程列表之前先检测，避免学习错误类型的课程
- 如果需要切换，及时中断当前处理，等待页面更新

### 2. 为什么延迟1秒点击？

```javascript
setTimeout(() => {
  tab.click();
}, 1000);
```

**原因：**
- 给页面一点时间完成初始化
- 避免点击过早导致事件未绑定
- 提高点击成功率

### 3. 为什么返回true？

```javascript
if (checkAndSwitchLearningType()) {
  // 正在切换，暂停课程列表处理
  return;
}
```

**流程：**
```
checkAndSwitchLearningType() 返回true
  ↓
handleCourseListPage() 立即返回
  ↓
不处理当前课程列表
  ↓
3秒后检测循环再次运行
  ↓
checkAndSwitchLearningType() 返回false（已在选修页面）
  ↓
handleCourseListPage() 继续处理选修课程
```

### 4. 正则表达式解析

```javascript
const match = text.match(/([\d.]+)学时\s*\/([\d.]+)学时/);
```

**匹配示例：**
```
输入: "20.00学时 /20学时"
match[0]: "20.00学时 /20学时"  (完整匹配)
match[1]: "20.00"              (第一个学时数)
match[2]: "20"                 (第二个学时数)
```

**支持的格式：**
- `20.00学时 /20学时` ✅
- `20学时/20学时` ✅
- `4.26 学时 / 30 学时` ✅

---

## 📝 更新日期
2025-11-10

## 🎯 新增功能
- ✅ 自动识别必修和选修学习进度
- ✅ 必修完成后自动切换到选修
- ✅ 智能判断当前应该学习的类型
- ✅ 详细的进度日志输出

---

## 🎉 功能效果

### 用户体验提升

**添加功能前：**
- ❌ 必修学完后，还在必修课程列表徘徊
- ❌ 不会自动切换到选修
- ❌ 需要手动点击"选修"标签
- ❌ 自动化中断

**添加功能后：**
- ✅ 必修学完后，自动检测
- ✅ 自动点击"选修"标签
- ✅ 自动继续学习选修课程
- ✅ 完全自动化，无需人工干预

### 智能化程度提升

- ✅ 实时监控学习进度
- ✅ 智能判断学习类型
- ✅ 自动切换学习内容
- ✅ 适应不同学习阶段

---

## 🎊 总结

这个功能实现了**真正的全自动学习**：

**智能流程：**
1. ✅ 启动插件 → 自动学习必修课程
2. ✅ 必修完成 → 自动切换到选修
3. ✅ 继续学习 → 自动学习选修课程
4. ✅ 都完成了 → 显示完成提示

**技术亮点：**
- DOM查询识别学习进度
- 正则表达式提取学时数据
- 智能判断学习类型
- 自动切换标签页

**现在插件真正实现了"一键启动，全程自动"！** 🎉

