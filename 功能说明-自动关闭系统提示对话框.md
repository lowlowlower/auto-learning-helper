# 功能说明 - 自动关闭系统提示对话框

## 📋 功能概述

插件现在可以**自动检测并关闭系统提示对话框**，无需手动点击"确定"按钮。

### 系统提示示例

**提示内容：**
```
系统提示
您的必修学时已满，可选择选修课程继续学习。
[确定]
```

**插件行为：**
- ✅ 自动检测到对话框
- ✅ 自动点击"确定"按钮
- ✅ 继续自动化流程

---

## 🔄 工作原理

### 检测时机

插件在**每次检测页面类型**时，都会先检查是否有系统提示对话框：

```javascript
async function detectPageAndRun() {
  // 首先检查是否有系统提示对话框
  checkAndCloseSystemDialog();  ✅
  
  // 然后检测页面类型
  if (video) {
    // 处理视频页面
  } else if (courseCards) {
    // 处理课程列表页面
  }
}
```

**检测频率：** 每3秒一次（随检测循环）

### 对话框识别

**识别逻辑：**

1. **查找按钮**
   ```javascript
   // 查找可能的确定按钮
   const dialogButtons = document.querySelectorAll(
     '.ivu-btn-primary',           // 主按钮
     '.ivu-btn-error',             // 错误按钮
     '.ivu-modal-confirm-footer button'  // 对话框底部按钮
   );
   ```

2. **检查按钮文本**
   ```javascript
   const btnText = btn.textContent.trim();
   
   if (btnText === '确定' || 
       btnText === '确认' || 
       btnText.includes('确定') || 
       btnText.includes('确认')) {
     // 找到确定按钮
   }
   ```

3. **验证是否在对话框中**
   ```javascript
   // 检查按钮是否在对话框容器中
   const dialog = btn.closest('.ivu-modal, .ivu-message, [class*="dialog"]');
   
   if (dialog || btn.classList.contains('ivu-btn-primary')) {
     // 确认这是对话框中的按钮
     btn.click();  // ✅ 点击
   }
   ```

---

## 📊 完整工作流程

### 场景1：刷新主页面时出现提示

```
刷新页面
  ↓
页面加载完成
  ↓
插件启动/恢复
  ↓
检测循环运行
  ↓
checkAndCloseSystemDialog()
  ↓
🔍 查找对话框按钮
  ├─ 查找 .ivu-btn-primary
  ├─ 查找 .ivu-btn-error
  └─ 查找对话框底部按钮
  ↓
✅ 找到"确定"按钮
  ↓
验证是否在对话框中
  ↓
✅ 验证通过
  ↓
等待500ms
  ↓
🖱️ 点击"确定"按钮
  ↓
对话框关闭 ✅
  ↓
继续检测页面类型
  ↓
处理课程列表/视频页面
```

### 场景2：学习过程中出现提示

```
正在学习课程
  ↓
系统弹出提示对话框
  ↓
(3秒后) 检测循环运行
  ↓
checkAndCloseSystemDialog()
  ↓
✅ 自动点击"确定"
  ↓
继续学习
```

---

## 💡 实现细节

### 函数实现

```javascript
function checkAndCloseSystemDialog() {
  // 1. 查找系统提示对话框中的"确定"按钮
  const dialogButtons = document.querySelectorAll(
    '.ivu-btn-primary, .ivu-btn-error, .ivu-modal-confirm-footer button'
  );
  
  // 2. 遍历所有按钮
  for (const btn of dialogButtons) {
    const btnText = btn.textContent.trim();
    
    // 3. 检查按钮文本是否包含"确定"、"确认"
    if (btnText === '确定' || btnText === '确认' || 
        btnText.includes('确定') || btnText.includes('确认')) {
      
      // 4. 检查是否有对话框容器（确保这是对话框中的按钮）
      const dialog = btn.closest('.ivu-modal, .ivu-message, [class*="dialog"], [class*="modal"]');
      
      if (dialog || btn.classList.contains('ivu-btn-primary') || btn.classList.contains('ivu-btn-error')) {
        // 5. 找到对话框按钮，自动点击
        console.log('🔔 发现系统提示对话框，自动点击确定');
        
        setTimeout(() => {
          btn.click();  // ✅ 点击
          console.log('✅ 已点击系统对话框确定按钮');
        }, 500);
        
        return true;
      }
    }
  }
  
  return false;
}
```

### 为什么延迟500ms点击？

```javascript
setTimeout(() => {
  btn.click();
}, 500);
```

**原因：**
- 给对话框一点时间完成渲染
- 确保对话框的事件监听器已绑定
- 提高点击成功率
- 避免过早点击导致无效

### 按钮选择器说明

| 选择器 | 用途 | 示例 |
|--------|------|------|
| `.ivu-btn-primary` | 主按钮（蓝色） | 确定、提交 |
| `.ivu-btn-error` | 错误按钮（红色） | 确定、删除 |
| `.ivu-modal-confirm-footer button` | 对话框底部按钮 | 确定、取消 |

### 为什么检查对话框容器？

**防止误点击非对话框按钮：**

```javascript
// ❌ 不检查容器（可能误点击页面上的其他"确定"按钮）
if (btnText === '确定') {
  btn.click();
}

// ✅ 检查容器（只点击对话框中的"确定"按钮）
const dialog = btn.closest('.ivu-modal');
if (dialog && btnText === '确定') {
  btn.click();
}
```

**对话框容器的特征：**
- `.ivu-modal` - iView模态对话框
- `.ivu-message` - iView消息提示
- `[class*="dialog"]` - 包含"dialog"的类名
- `[class*="modal"]` - 包含"modal"的类名

---

## 📊 Console输出示例

### 发现并点击对话框

```
[自动学习助手] 检测页面类型... https://web.scgb.gov.cn/#/myClass?id=...
[自动学习助手] 🔔 发现系统提示对话框，自动点击确定 <button class="ivu-btn ivu-btn-primary">确定</button>
[自动学习助手] ✅ 已点击系统对话框确定按钮
[自动学习助手] ✅ 这是课程列表页面
[自动学习助手] 📚 找到课程: 20个
```

### 没有对话框时

```
[自动学习助手] 检测页面类型... https://web.scgb.gov.cn/#/myClass?id=...
[自动学习助手] ✅ 这是课程列表页面
[自动学习助手] 📚 找到课程: 20个
```

---

## 🧪 测试方法

### 测试1：刷新主页面

1. **打开课程列表页面（myClass页面）**
2. **按F5刷新页面**
3. **观察是否出现"必修学时已满"提示**

**预期结果：**
- 对话框出现后，插件自动检测
- 500ms后自动点击"确定"
- 对话框关闭，继续正常运行

**Console输出：**
```
[自动学习助手] 🔔 发现系统提示对话框，自动点击确定
[自动学习助手] ✅ 已点击系统对话框确定按钮
```

### 测试2：验证对话框识别

在页面上，打开Console执行：

```javascript
// 手动查找对话框按钮
const dialogButtons = document.querySelectorAll('.ivu-btn-primary, .ivu-btn-error');
console.log('找到的按钮:', dialogButtons);

// 检查每个按钮
dialogButtons.forEach(btn => {
  console.log('按钮文本:', btn.textContent.trim());
  console.log('是否在对话框中:', btn.closest('.ivu-modal') !== null);
});
```

### 测试3：多次刷新测试

1. 多次刷新页面（F5）
2. 每次观察对话框是否自动关闭
3. 验证插件是否继续正常工作

**预期结果：**
- 每次刷新都能自动关闭对话框
- 不影响后续的学习流程

---

## 💡 技术要点

### 1. 每次检测都检查对话框

**设计原因：**
- 对话框可能在任何时候出现
- 刷新页面时出现
- 学习过程中出现
- 切换标签时出现

**解决方案：**
- 在检测循环中每次都检查
- 频率：每3秒
- 确保及时处理

### 2. 为什么使用closest()？

```javascript
const dialog = btn.closest('.ivu-modal');
```

**closest()的作用：**
- 向上查找最近的匹配元素
- 从按钮开始，向上查找父元素
- 直到找到`.ivu-modal`或到达根元素

**示例：**
```html
<div class="ivu-modal">        ← closest('.ivu-modal') 会找到这里
  <div class="ivu-modal-body">
    <div class="ivu-modal-footer">
      <button class="ivu-btn-primary">确定</button>  ← 从这里开始查找
    </div>
  </div>
</div>
```

### 3. 为什么返回true/false？

```javascript
if (checkAndCloseSystemDialog()) {
  // 找到并点击了对话框
  return true;
}
```

**虽然当前没有使用返回值，但预留了扩展性：**
- 未来可能需要知道是否点击了对话框
- 可能需要在点击后执行特定操作
- 更好的代码设计

---

## 🎯 适用场景

### 已测试的对话框类型

1. **必修学时已满提示**
   ```
   系统提示
   您的必修学时已满，可选择选修课程继续学习。
   [确定]
   ```

2. **其他可能的系统提示**
   - 学习完成提示
   - 进度更新提示
   - 课程切换提示
   - 任何包含"确定"或"确认"按钮的对话框

### 按钮文本识别

**支持的文本：**
- "确定"
- "确认"
- "确 定"（包含空格）
- "确定(9)"（带倒计时）
- "确定并继续"
- 任何包含"确定"或"确认"的文本

---

## 📝 更新日期
2025-11-10

## 🎯 新增功能
- ✅ 自动检测系统提示对话框
- ✅ 自动点击"确定"/"确认"按钮
- ✅ 每次检测循环都检查
- ✅ 支持多种对话框类型

---

## 🎉 功能效果

### 用户体验提升

**添加功能前：**
- ❌ 刷新页面后，需要手动点击"确定"
- ❌ 对话框阻塞自动化流程
- ❌ 需要人工干预
- ❌ 影响自动化体验

**添加功能后：**
- ✅ 刷新页面后，自动点击"确定"
- ✅ 对话框自动关闭
- ✅ 无需人工干预
- ✅ 完整的自动化体验

### 自动化完善度

**现在插件可以自动处理：**
1. ✅ 视频页面的确认对话框（继续上次学习进度）
2. ✅ 系统提示对话框（必修学时已满）
3. ✅ 其他任何包含"确定"/"确认"的对话框

**真正的"无需人工干预"！**

---

## 🎊 总结

这个功能完善了插件的自动化能力，解决了刷新页面时需要手动点击"确定"的问题。

**核心改进：**
1. ✅ **主动检测** - 每次检测循环都检查对话框
2. ✅ **智能识别** - 识别多种对话框类型
3. ✅ **自动点击** - 500ms延迟后自动点击
4. ✅ **不影响流程** - 点击后继续正常运行

**工作原理：**
```
检测循环（每3秒）
  ↓
首先检查对话框
  ├─ 有对话框 → 自动点击"确定" → 继续
  └─ 无对话框 → 直接继续
  ↓
检测页面类型
  ↓
处理视频/课程列表
```

**与视频页面确认对话框的区别：**
- **视频页面对话框**：只在视频页面检测
- **系统提示对话框**：在所有页面检测（每次检测循环）

**完美实现了"一键启动，全程自动，无需干预"！** 🎉

